*** genconfig_a.sh	2019-11-02 17:20:00.019902507 +0100
--- genconfig_b.sh	2019-10-12 15:29:17.669976425 +0200
***************
*** 1,10 ****
  #! /bin/sh
! # $Id: genconfig.sh,v 1.98 2019/09/01 22:59:15 nanard Exp $
  # vim: tabstop=4 shiftwidth=4 noexpandtab
  #
  # miniupnp daemon
  # http://miniupnp.free.fr or https://miniupnp.tuxfamily.org/
! # (c) 2006-2018 Thomas Bernard
  # This software is subject to the conditions detailed in the
  # LICENCE file provided within the distribution
  
--- 1,10 ----
  #! /bin/sh
! # $Id: genconfig.sh,v 1.101 2019/09/24 11:52:15 nanard Exp $
  # vim: tabstop=4 shiftwidth=4 noexpandtab
  #
  # miniupnp daemon
  # http://miniupnp.free.fr or https://miniupnp.tuxfamily.org/
! # (c) 2006-2019 Thomas Bernard
  # This software is subject to the conditions detailed in the
  # LICENCE file provided within the distribution
  
***************
*** 102,108 ****
  
  echo "/* MiniUPnP Project" >> ${CONFIGFILE}
  echo " * http://miniupnp.free.fr/ or https://miniupnp.tuxfamily.org/" >> ${CONFIGFILE}
! echo " * (c) 2006-2018 Thomas Bernard" >> ${CONFIGFILE}
  echo " * generated by $0 on `date`" >> ${CONFIGFILE}
  echo " * `uname -a`" >> ${CONFIGFILE}
  if [ -z "$*" ] ; then
--- 102,108 ----
  
  echo "/* MiniUPnP Project" >> ${CONFIGFILE}
  echo " * http://miniupnp.free.fr/ or https://miniupnp.tuxfamily.org/" >> ${CONFIGFILE}
! echo " * (c) 2006-2019 Thomas Bernard" >> ${CONFIGFILE}
  echo " * generated by $0 on `date`" >> ${CONFIGFILE}
  echo " * `uname -a`" >> ${CONFIGFILE}
  if [ -z "$*" ] ; then
***************
*** 162,168 ****
  		FW=pf
  		echo "#define USE_IFACEWATCHER 1" >> ${CONFIGFILE}
  		OS_URL=http://www.openbsd.org/
! 		V6SOCKETS_ARE_V6ONLY=`sysctl -n net.inet6.ip6.v6only`
  		;;
  	FreeBSD | GNU/kFreeBSD)
  		VER=`grep '#define __FreeBSD_version' /usr/include/sys/param.h | awk '{print $3}'`
--- 162,170 ----
  		FW=pf
  		echo "#define USE_IFACEWATCHER 1" >> ${CONFIGFILE}
  		OS_URL=http://www.openbsd.org/
! 		# net.inet6.ip6.v6only has been removed in recent OpenBSD versions
! 		# Default to 1 in that case
! 		V6SOCKETS_ARE_V6ONLY=`sysctl -n net.inet6.ip6.v6only || echo 1`
  		;;
  	FreeBSD | GNU/kFreeBSD)
  		VER=`grep '#define __FreeBSD_version' /usr/include/sys/param.h | awk '{print $3}'`
***************
*** 310,327 ****
  			esac
  		fi
  		echo "#define USE_IFACEWATCHER 1" >> ${CONFIGFILE}
! 		FW=netfilter
  		V6SOCKETS_ARE_V6ONLY=`/sbin/sysctl -n net.ipv6.bindv6only`
  		;;
  	OpenWRT)
  		OS_URL=http://www.openwrt.org/
  		echo "#define USE_IFACEWATCHER 1" >> ${CONFIGFILE}
! 		FW=netfilter
  		;;
  	AstLinux)
  		OS_URL=http://www.astlinux.org/
  		echo "#define USE_IFACEWATCHER 1" >> ${CONFIGFILE}
! 		FW=netfilter
  		;;
  	Tomato)
  		OS_NAME=UPnP
--- 312,334 ----
  			esac
  		fi
  		echo "#define USE_IFACEWATCHER 1" >> ${CONFIGFILE}
! 		# Would be better to check for actual presence of nftable rules, but that requires root privileges
! 		if [ -x "$(command -v nft)" ]; then
! 			FW=nftables
! 		else
! 			FW=iptables
! 		fi
  		V6SOCKETS_ARE_V6ONLY=`/sbin/sysctl -n net.ipv6.bindv6only`
  		;;
  	OpenWRT)
  		OS_URL=http://www.openwrt.org/
  		echo "#define USE_IFACEWATCHER 1" >> ${CONFIGFILE}
! 		FW=iptables
  		;;
  	AstLinux)
  		OS_URL=http://www.astlinux.org/
  		echo "#define USE_IFACEWATCHER 1" >> ${CONFIGFILE}
! 		FW=iptables
  		;;
  	Tomato)
  		OS_NAME=UPnP
***************
*** 337,343 ****
  		echo "#ifdef TCONFIG_IPV6" >> ${CONFIGFILE}
  		echo "#define ENABLE_IPV6" >> ${CONFIGFILE}
  		echo "#endif" >> ${CONFIGFILE}
! 		FW=netfilter
  		;;
  	Darwin)
  		MAJORVER=`echo $OS_VERSION | cut -d. -f1`
--- 344,350 ----
  		echo "#ifdef TCONFIG_IPV6" >> ${CONFIGFILE}
  		echo "#define ENABLE_IPV6" >> ${CONFIGFILE}
  		echo "#endif" >> ${CONFIGFILE}
! 		FW=iptables
  		;;
  	Darwin)
  		MAJORVER=`echo $OS_VERSION | cut -d. -f1`
***************
*** 368,375 ****
  	ipfw)
  		echo "#define USE_IPFW 1" >> ${CONFIGFILE}
  		;;
! 	netfilter)
  		echo "#define USE_NETFILTER 1" >> ${CONFIGFILE}
  		;;
  	*)
  		echo "Unknown Firewall/packet filtering software [$FW]"
--- 375,387 ----
  	ipfw)
  		echo "#define USE_IPFW 1" >> ${CONFIGFILE}
  		;;
! 	iptables)
  		echo "#define USE_NETFILTER 1" >> ${CONFIGFILE}
+ 		echo "#define USE_IPTABLES  1" >> ${CONFIGFILE}
+ 		;;
+ 	nftables)
+ 		echo "#define USE_NETFILTER 1" >> ${CONFIGFILE}
+ 		echo "#define USE_NFTABLES  1" >> ${CONFIGFILE}
  		;;
  	*)
  		echo "Unknown Firewall/packet filtering software [$FW]"
***************
*** 387,395 ****
  		if grep uuid_create /usr/include/uuid.h > /dev/null 2>&1 ; then
  			echo "#define BSD_UUID" >> ${CONFIGFILE}
  		fi
! 		if grep uuid_generate /usr/include/uuid/uuid.h > /dev/null 2>&1 ; then
! 			echo "#define LIB_UUID" >> ${CONFIGFILE}
! 		fi
  		;;
  esac
  
--- 399,407 ----
  		if grep uuid_create /usr/include/uuid.h > /dev/null 2>&1 ; then
  			echo "#define BSD_UUID" >> ${CONFIGFILE}
  		fi
! #		if grep uuid_generate /usr/include/uuid/uuid.h > /dev/null 2>&1 ; then
! #			echo "#define LIB_UUID" >> ${CONFIGFILE}
! #		fi
  		;;
  esac
  
